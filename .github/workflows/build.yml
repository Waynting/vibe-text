name: Build Desktop Apps

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4


      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Vibe Text ${{ github.ref_name }}'
          releaseBody: |
            ## 🎉 Vibe Text ${{ github.ref_name }}
            
            一個優雅的直式中文文字編輯器，支援傳統由右至左的書寫方式。
            
            ### 📥 下載安裝檔
            
            選擇你的作業系統：
            
            - 🍎 **macOS**: 下載 `.dmg` 檔案（支援 Intel 和 Apple Silicon）
            - 🪟 **Windows**: 下載 `.exe` 安裝檔  
            
            ### 🌐 網頁版
            
            不想安裝？直接使用網頁版：**[vibe-text-ntu.vercel.app](https://vibe-text-ntu.vercel.app)**
            
            ### ✨ 此版本新功能
            
            - 📝 直式文字編輯，支援傳統中文書寫方式
            - 🎨 深色/淺色主題切換
            - 💾 本地檔案儲存與開啟
            - ⌨️ 完整快捷鍵支援
            - 📊 即時字數統計
            - 🔄 文字方向切換
            - 📋 文件說明功能
            
            ### 🆘 需要幫助？
            
            - 📖 [使用說明](https://github.com/${{ github.repository }}#快速開始)
            - 🐛 [回報問題](https://github.com/${{ github.repository }}/issues)
            
            ---
            🤖 *自動建構 with GitHub Actions*
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}